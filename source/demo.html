<!DOCTYPE html>
<html lang="en">
<head>
    <title>SpecIF to ePub</title>
	<meta charset="utf-8" />
	<!--<meta http-equiv="cache-control" content="no-Cache" />-->
	<meta http-equiv="expires" content="0" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<script type="text/javascript" src="./lib/jquery/jquery-3.3.1.min.js"></script>
	<script type="text/javascript" src="./lib/filesaver/src/fileSaver.js"></script>
	<script type="text/javascript" src="./lib/ajv/ajv-4.11.8.min.js"></script>
	<script type="text/javascript" src="./lib/jszip/dist/jszip.js"></script>
	<script type="text/javascript" src="https://specif.de/v0.10.4/check.js"></script>
	<script type="text/javascript" src="./lib/specif/importSpecif.js"></script>
	<script type="text/javascript" src="./js/toXhtml.js"></script>
	<script type="text/javascript" src="./js/toEpub.js"></script>
</head>
<body>
<script type="text/javascript">
////////////////////////////////////////////////////
// This demo app imports SpecIF data from a file and uses 
// the toEpub and toXhtml routines to create an ePub Document. 
// Copyright: adesso AG (http://adesso.de)
// License: Apache 2.0 (http://www.apache.org/licenses/)
//

var file = null,						// the picked import file
	importSpecif = new ImportSpecif();	// the import routine for SpecIF files

// the demo app:
var app = {
	verify: function() {

		// initialize:
		importSpecif.open();

		// get the selected file:
        file = document.getElementById("importFile").files[0];

		// check if file-type is eligible:
		file = importSpecif.verify( file ); 
		if( file )
			document.getElementById("startButton").disabled = false
			// user may start the conversion
		else
			alert('wrong file-type')
			// try again
	},
	main: function() {
		var options = { 
				// If a hidden property is defined with value, it is suppressed only if it has this value;
				// if the value is undefined, the property is suppressed in all cases.
				hiddenProperties: [{title:'SpecIF:Type',value:'SpecIF:Folder'},{title:'SpecIF:Type',value:'Folder'}],  // type is hidden in case of folder
				hideEmptyProperties: true,
				// if no label is provided, the respective content is suppressed:
				propertiesLabel: 'Properties',
				statementsLabel: 'Statements',
				done: function() { alert("File is saved according to your browser's configuration.") },
				fail: function(err) { alert(err.statusText) }
			};
		readFile( file, importSpecif.asBuf );
		return

		function readFile( f, fn ) {
//			console.debug( 'readFile ' + f.name );
			var rdr = new FileReader();
			rdr.onload = function(evt) {
				fn( evt.target.result )		// import the file as arraybuffer
					.done( function() {
						// process:
						console.info('specif',myProject.value);
						document.getElementById("startButton").disabled = true;
						toEpub( myProject.value, options )
					})
					.fail( function() {alert('failure to import the data')} )
			};
			rdr.readAsArrayBuffer( f )
		}
	}
}

///////////////////////////////////////////
// used by importSpecif to check and manipulate SpecIF data:
var	specif = {
		check: function( data ) {
			// check the SpecIF data:
			var cDO = $.Deferred();
			// 1. Validate the data using the SpecIF schema:
			cDO.notify('Checking schema',10);

			// Get the specified schema file from the server:
			get( 
				"https://specif.de/v"+data.specifVersion+"/schema", 
				'arraybuffer',	// response type
				false,	// no authentication
				function(xhr) { 
//					console.debug('schema', xhr);
					switch( xhr.status ) {
						case 200:
							// 1. check data against schema:
							let rc = checkSchema( JSON.parse( buf2str(xhr.response) ), data );
							if( rc.status!=0 ) { cDO.reject( rc ); return };

							// 2. Check further constraints:
							cDO.notify('Checking constraints',20);
							rc = checkConstraints( data );
							if( rc.status==0 ) 	cDO.resolve( data, rc )
							else 				cDO.reject( rc );
							break
						case 404:
							xhr = { status: 903, statusText: 'SpecIF version '+data.specifVersion+' is not supported by the program!' };
						default:
							cDO.reject(xhr)
					}
				}, 
				null
			);
			return cDO
			
			function get(url,rspT,auth,successFn,nextFn) {
				// https://blog.garstasio.com/you-dont-need-jquery/
				// https://www.sitepoint.com/guide-vanilla-ajax-without-jquery/
				var xhr = new XMLHttpRequest();
				xhr.open('GET', url, true);
				xhr.withCredentials = auth;
				// https://stackoverflow.com/a/42916772/2214
				xhr.responseType = rspT;
				xhr.onreadystatechange = function () {
			//		console.debug('xhr',this.readyState,this)
					if (this.readyState<4 ) return;
					if (this.readyState==4 && this.status==200) {
						if( typeof successFn=="function" ) successFn(this)
					};
					// continue in case of success and error:
					if( typeof nextFn=="function" ) nextFn()	
				};
				xhr.send(null)
			}
		}
	};
// used by importSpecif to cache the data:
var myProject = {
		value: null,
		create: function( data ) {
//			console.debug('myProject.create',data);
			var dO = $.Deferred();
			this.value = data;
			dO.resolve(null,'',{status:201});
			return dO
		},
		abort: function() {
			// not implemented
		}
	};
// used by importSpecif for transformation:
	const CONFIG = {
		imgExtensions: [ 'png', 'jpg', 'svg', 'gif', 'jpeg', 'png' ],
		officeExtensions: []		// not supported (yet??)
	};
	function buf2str(buf) {
		// UTF-8 character table: http://www.i18nqa.com/debug/utf8-debug.html
		// or: https://bueltge.de/wp-content/download/wk/utf-8_kodierungen.pdf
		try {
			// see https://developers.google.com/web/updates/2014/08/Easier-ArrayBuffer-String-conversion-with-the-Encoding-API
			// DataView is a wrapper on top of the ArrayBuffer.
			var dataView = new DataView(buf);
			// see http://encoding.spec.whatwg.org/#interface-textdecoder
			var decoder = new TextDecoder('utf-8');
			return decoder.decode(dataView)
		} catch (e) {
			// see https://developers.google.com/web/updates/2012/06/How-to-convert-ArrayBuffer-to-and-from-String
			// for vintage browsers such as IE
			// Known problem: Special chars like umlaut are not properly converted.
			return String.fromCharCode.apply(null, new Uint8Array(buf))
		}
	}
	String.prototype.fileExt = function() {
		// return the file extension without the dot:
		return this.substring( this.lastIndexOf('.')+1 )
	};
	String.prototype.trimJSON = function() {
		// trim all characters outside the outer curly brackets, which may include the UTF-8 byte-order-mask: 
		let si = this.indexOf('{'),
			li = this.lastIndexOf('}');
		return this.substring(si,li+1)
	};
</script>
<div id="main">
	<h1>SpecIF to ePub Converter</h1>
	<div style="padding-left:1em">
		<p>Please pick a file of type specif or specifz:<br />
			<input id="importFile" type="file" onchange="app.verify()" />
		</p>
		<p>Read SpecIF file and in transform to ePub:<br />
			<button id="startButton" type="button" disabled onclick="app.main()" >Start</button>
		</p>
	</div>
</div>
</body>
</html>